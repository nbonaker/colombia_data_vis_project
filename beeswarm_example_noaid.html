<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>ðŸš©s of Colombia</title>
    <!-- Load d3.js -->
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script type="module" src="bubbles_cari.js"></script>
    <link rel="stylesheet" href="main_stylesheet.css">
</head>
<style>
    .bubble-box{
        background-color:white;
        background-clip: content-box;
        border-radius: 20px;
        width: 60%;
        height: 100%;
        display: table-cell;

    }
    .description-box{
        background-color:white;
        background-clip: content-box;
        border-radius: 20px;
        width: 33%;
        height: 100%;
        display: table-cell;
        padding-left: 5px;
        vertical-align: top;
    }
    .description-box-text{
        display: block;
        width: 95%;
        height: 95%;
        padding-left: 5%;
        padding-top: 5%;
    }
    .axis-grid line {
        stroke: #d5d5d5;
    }
</style>
<body>

<div class="title-box">
    <div class="title-box-text">Are the food insecure receiving aid?</div>
</div>

<div class="content-container">
    <div style="display: table-row; padding: 10px;">
        <div class="bubble-box">
            <div id="bubble-graph"></div>
        </div>
        <div class="description-box">
            <div class="description-box-text">
                <h3 style="font-size: 2em;">Many of those most in need aren't getting help</h3>
                    <p style="font-size: 1.0em;">Those who are food insecure are not able to meet their basic requirements for sustenance. These
                        are the ones who are most in need of a helping hand to live at a basic human level.
                    </p>
                    <p style="font-size: 1.0em;"> <b>30% of the food insecure</b> are not receiving any government aid whatsoever. If a program could
                        be enacted that meets these people where they are and supports their needs, these families may be able to rise to a level of 
                        food security.
                    </p>
                    <p style="font-size: 1.0em;"> <b>45% of the marginally food secure</b> are not receiving any government aid as well. If the program
                        that was enacted helped these people, they would be able to avoid being pushed into food insecurity by a financial shock. This
                        would also prevent them from becoming a greater burden on the government's finances in the future. 
                    </p>
                <h3>Legend:</h3>
                    <p>The <b>x-axis</b> groups households by food insecurity level </p>
                    <p>The <b>y-axis</b> shows the median monthly expenditure on food in USD </p>
                    <p>Each <b>bubble</b> represents a locality in our dataset. The relative size of each bubble shows
                    the amount of people in each locality.</p> Localities are split into each food security group.

            </div>
        </div>
    </div>
</div>

<div id="includeHtml" class="timeline-box"></div>
<script>
    $(function() {
        $("#includeHtml").load("timeline.html");
    });

    let box = document.querySelector('.bubble-box');
    let width = box.clientWidth;
    let height = box.clientHeight;
    console.log(width)
    console.log(height)
    const margin = [0, 0, 50, 180];

    let svg = d3
        .select(".bubble-box")
        .append("svg")
        .attr("height", height)
        .attr("width", width);

    d3.csv("data_files/food_cost_data.csv").then((data) => {
        console.log(data)
        // let sectors = Array.from(new Set(data.map((d) => d.cari_category)));
        // console.log(sectors)
        let sectors = ["Severe Insecurity", "Moderate Insecurity",  "Marginal Security", "Secure"]

        let xScale = d3
            .scaleBand()
            .domain(sectors)
            .range([margin[3], width - margin[1]]);
        var x_axis = d3.axisBottom()
            .scale(xScale);
        var xAxisTranslate = height - margin[2]+10;
        svg.append("g")
            .attr("transform", "translate(-105, " + xAxisTranslate  +")")
            .call(x_axis)

        let yScale = d3
            .scaleLinear()
            .domain(d3.extent(data.map((d) => +d["cost_food_total"])))
            .domain([0, 1600000*0.00021])
                .range([height - margin[2], margin[0]]);
        var y_axis = d3.axisLeft()
            .scale(yScale);
        svg.append("g").attr("transform", "translate(75, 10)").call(y_axis)

        svg.append("text")
            .attr("class", "y label")
            .attr("text-anchor", "middle")
            .attr("y", 6)
            .attr("dy", ".75em")
            .attr("transform", "rotate(-90), translate(-"+height/2+", 10)")
            .text("Total Amount Spent on Food Each Month (USD)");

        const yAxisGrid = d3.axisLeft(yScale).tickSize(-width+margin[3]+margin[1]).tickFormat('').ticks(10);
        svg.append('g')
            .attr('class', 'y axis-grid')
            .attr("transform", "translate(75, 10)")
            .call(yAxisGrid);

        // let color = d3.scaleOrdinal().domain(sectors).range(["#910b00", "#ff1200", "#24c6f3", "#e3e3e3"]);
        function color(cari, aid) {
            if (aid > 0.6){
                return "#e3e3e3"
            } else {
                cari_colors = ["#910b00", "#ff746c", "#24c6f3", "#e3e3e3"];
                return cari_colors[sectors.indexOf(cari)];
            }
        }

        let marketcapDomain = d3.extent(data.map((d) => +d["household_size"]));
        let size = d3.scaleSqrt().domain(marketcapDomain).range([3, 15]);

        svg
            .selectAll(".circ")
            .data(data)
            .enter()
            .append("circle")
            .attr("class", "circ")
            .attr("stroke", "black")
            .attr("fill", (d) => color(d.cari_category, d.government_assistance))
            .attr("r", (d) => size(d["household_size"]))
            .attr("cx", (d) => xScale(d.cari_category))
            .attr("cy", (d) => yScale(d.cost_food_total*0.00021));

        let simulation = d3
            .forceSimulation(data)
            .force(
                "x",
                d3
                    .forceX((d) => {
                        return xScale(d.cari_category)-5;
                    })
                    .strength(0.2)
            )
            .force(
                "y",
                d3
                    .forceY(function (d) {
                        return yScale(d.cost_food_total*0.00021);
                    })
                    .strength(1)
            )
            .force(
                "collide",
                d3.forceCollide((d) => {
                    return size(d["household_size"]);
                })
            )
            .alphaDecay(0)
            .alpha(0.3)
            .on("tick", tick);

        function tick() {
            d3.selectAll(".circ")
                .attr("cx", (d) => d.x)
                .attr("cy", (d) => d.y);
        }

        let init_decay = setTimeout(function () {
            console.log("start alpha decay");
            simulation.alphaDecay(0.03);
        }, 1000);


    });
</script>