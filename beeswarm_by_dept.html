<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>ðŸš©s of Colombia</title>
    <!-- Load d3.js -->
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script type="module" src="./bubbles_simple.js"></script>
    <link rel="stylesheet" href="main_stylesheet.css">
</head>
<style>
    .bubble-box{
        background-color:white;
        background-clip: content-box;
        border-radius: 20px;
        width: 60%;
        height: 100%;
        display: table-cell;

    }
    .description-box{
        background-color:white;
        background-clip: content-box;
        border-radius: 20px;
        width: 33%;
        height: 100%;
        display: table-cell;
        padding-left: 5px;
        vertical-align: top;
    }
    .description-box-text{
        display: block;
        width: 95%;
        height: 95%;
        padding-left: 5%;
        padding-top: 5%;
    }
    .axis-grid line {
        stroke: #d5d5d5;
    }
</style>
<body>

<div class="title-box">
    <div class="title-box-text">Food Security and Food Expenditures</div>
</div>

<div class="content-container">
    <div style="display: table-row; padding: 10px;">
        <div class="bubble-box">
            <div id="bubble-graph"></div>
        </div>
        <div class="description-box">
            <div class="description-box-text">Here you can put some info about the graph :)</div>
        </div>
    </div>
</div>

<div id="includeHtml" class="timeline-box"></div>
<script>
    $(function() {
        $("#includeHtml").load("timeline.html");
    });

    let box = document.querySelector('.bubble-box');
    let width = box.clientWidth;
    let height = box.clientHeight;
    console.log(width)
    console.log(height)
    const margin = [0, 0, 50, 180];

    let svg = d3
        .select(".bubble-box")
        .append("svg")
        .attr("height", height)
        .attr("width", width);

    const x_var = "cari_category";
    const y_var = "government_assistance";
    const size_var = "household_size";
    const color_var = "government_assistance"

    d3.csv("./data_files/by_department/bogota_dc_clean_dataset.csv").then((data) => {
        console.log(data)
        // let sectors = Array.from(new Set(data.map((d) => d.cari_category)));
        // console.log(sectors)
        let sectors = ["Severe Insecurity", "Moderate Insecurity",  "Marginal Security", "Secure"]

        let xScale = d3
            .scaleBand()
            .domain(sectors)
            .range([margin[3], width - margin[1]]);
        var x_axis = d3.axisBottom()
            .scale(xScale);
        var xAxisTranslate = height - margin[2]+10;
        svg.append("g")
            .attr("transform", "translate(-105, " + xAxisTranslate  +")")
            .call(x_axis)

        let yScale = d3
            .scaleLinear()
            .domain(d3.extent(data.map((d) => +d[y_var])))
            .domain([-0.5, 1.5])
                .range([height - margin[2], margin[0]]);
        var y_axis = d3.axisLeft()
            .scale(yScale);
        svg.append("g").attr("transform", "translate(75, 10)").call(y_axis)

        const yAxisGrid = d3.axisLeft(yScale).tickSize(-width+margin[3]+margin[1]).tickFormat('').ticks(10);
        svg.append('g')
            .attr('class', 'y axis-grid')
            .attr("transform", "translate(75, 10)")
            .call(yAxisGrid);

        let color = d3.scaleOrdinal().domain(sectors).range(["#910b00", "#0443a6"]);

        let marketcapDomain = d3.extent(data.map((d) => +d[size_var]));
        let size = d3.scaleSqrt().domain(marketcapDomain).range([3, 15]);

        svg
            .selectAll(".circ")
            .data(data)
            .enter()
            .append("circle")
            .attr("class", "circ")
            .attr("stroke", "black")
            .attr("fill", (d) => color(d[color_var]))
            .attr("r", (d) => size(d[size_var]))
            .attr("cx", (d) => xScale(d[x_var]))
            .attr("cy", (d) => yScale(d[y_var]));

        let simulation = d3
            .forceSimulation(data)
            .force(
                "x",
                d3
                    .forceX((d) => {
                        return xScale(d[x_var])-5;
                    })
                    .strength(1)
            )
            .force(
                "y",
                d3
                    .forceY(function (d) {
                        return yScale(d[y_var]);
                    })
                    .strength(1)
            )
            .force(
                "collide",
                d3.forceCollide((d) => {
                    return size(d[size_var]);
                })
            )
            .alphaDecay(0)
            .alpha(0.3)
            .on("tick", tick);

        function tick() {
            d3.selectAll(".circ")
                .attr("cx", (d) => d.x)
                .attr("cy", (d) => d.y);
        }

        let init_decay = setTimeout(function () {
            console.log("start alpha decay");
            simulation.alphaDecay(0.03);
        }, 1000);


    });
</script>