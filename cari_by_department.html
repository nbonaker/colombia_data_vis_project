<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>ðŸš©s of Colombia</title>
    <!-- Load d3.js -->
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
<!--    <script src="https://d3js.org/d3.v4.js"></script>-->
    <script src="https://d3js.org/d3.v6.js" charset="utf-8"></script>

    <link href="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.js"></script>
    <script type="module" src="./bubbles.js"></script>
    <link rel="stylesheet" href="main_stylesheet.css">
</head>
<style>
    .map-box{
        background-color:white;
        background-clip: content-box;
        border-radius: 20px;
        width: 50%;
        height: 100%;
        display: table-cell;

    }
    #map {
        border-radius: 20px;
        background-clip: content-box;
        width: 100%;
        height: 100%;
    }

    .data-box{
        background-color:white;
        background-clip: content-box;
        border-radius: 20px;
        width: 50%;
        height: 50%;
        display: table-cell;
        vertical-align: top;
    }
    .bubble-box{
        width: 100%;
        height: 75%;
        /*vertical-align: top;*/
    }
    .description-box{
        background-color:white;
        background-clip: content-box;
        border-radius: 20px;
        width: 100%;
        height: 14%;
        /*display: table-row;*/
        padding-left: 5px;
        padding-bottom: 5px;
        vertical-align: top;
    }
    .description-box-text{
        display: block;
        width: 95%;
        height: 100%;
        padding-left: 1rem;
        padding-top: 0.5rem;
    }
    .tooltip-donut {
        position: absolute;
        text-align: center;
        padding: .5rem;
        background: #FFFFFF;
        color: #313639;
        border: 1px solid #313639;
        border-radius: 8px;
        pointer-events: none;
        font-size: 1.0rem;
        z-index: 2;
    }
    .content-container{
        width: 100%;
        height: 66%;
        display: table;
        padding-top: 5px;
        padding-bottom: 5px;
    }
</style>
<body>

<div class="title-box">
    <div class="title-box-text">Where is food security the lowest?</div>
</div>

<div class="content-container">
    <div style="display: table-row; padding: 10px;">
        <div class="map-box">
            <div id="map" ></div>
        </div>
        <div class="data-box">
            <!-- Create a div where the graph will take place -->
            <div style="padding-left: 15px; padding-top: 15px;">
                <p>The map at left shows the level of food insecurity in each department relative to the national average.
                    Red flags denote areas with greater food insecurity than the national average, and blue flags denote areas
                    with less food insecurity. Food insecurity seems to be highest in the border regions of the country and lowest
                    in the center.
                </p>
                <h3>Click on a flag to display data for the corresponding department.</h3>
                <p><b><span id="aid_percentage_label">None</span>%</b> of people live with food insecurity in
                    <b><span id="department_label">None</span></b>
                </p>
                    <select name="hue" id="color_select" style="display: none">
                    <option value="cari">Food Security Level</option>
                    <option value="gov_aid">Receives Aid</option>
                </select>
            </div>
            <div class="bubble-box">
                <div id="my_dataviz"></div>
            </div>
        </div>

    </div>
</div>
<div class="description-box">
    <div class="description-box-text">
        <p style="margin-top: 0"><b>How to Explore the Data:</b><img src = "red_flag_icon.svg" width="20" height="20"/> Lighter red flags show the locations of departments
            with available data. <img src = "deep_red_flag_icon.svg" width="20" height="20"/> The darker red flag denotes the currently
            selected department. You can change between departments with the dropdown menu above the bubble chart.
            You can also choose between coloring the bubbles by food security level or whether they receive government aid.
        </p>
        <p>Each bubble represents a household in the selected department. Relative size of the bubbles shows the number of people in the household.</p>
    </div>
</div>

<div id="includeHtml" class="timeline-box"></div>

<script type="module">
    $(function() {
        $("#includeHtml").load("timeline.html");
    });

    /////////////////////////////////////Map stuff
    // load mabbox map
    mapboxgl.accessToken = "pk.eyJ1IjoibmJvbmFrZXIiLCJhIjoiY2p0bmRkNmdtMDloZzQ0cXBpM2trb2owYyJ9.WthQbtkv3vaXA8rrVoo-hg";
    const map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/nbonaker/clgvf3qjv00d701pi6xyafcbq",
        center: [-73.2973, 3.9],
        zoom: 4.2, // starting zoom level
        dragPan: false,
        interactive: false
    });
    // disable map zoom when using scroll
    map.scrollZoom.disable();

    function create_flag_markers(station_data, icon_file, markers) {

        console.log(station_data)
        markers = marker_container
            .selectAll("circle")
            .data(station_data)
            .enter()
            .append("svg:image")
            .attr('width', 25)
            .attr('height', 25)
            .attr('opacity', '1')
            .attr('selected', '0')
            .attr('position', 'relative')
            .attr("xlink:href", function (d){
                if (d.cari_quantiles == 0) {
                    return './red_flag_icons/blue_outline.svg'
                } else if (d.cari_quantiles == 1) {
                    return './red_flag_icons/light_blue_outline.svg'
                } else if (d.cari_quantiles == 2) {
                    return './red_flag_icons/light_red_outline.svg'
                } else {
                    return './red_flag_icons/red_outline.svg'
                }
            })
            .attr("id", function (d) {
                return d.department;
            })
            .on('mouseover', function (data, i) {
                d3.select(this).raise();

                d3.select(this).attr("xlink:href", function(i){
                        if (i.cari_quantiles == 0) {
                            return './red_flag_icons/blue.svg'
                        } else if (i.cari_quantiles == 1) {
                            return './red_flag_icons/light_blue.svg'
                        } else if (i.cari_quantiles == 2) {
                            return './red_flag_icons/light_red.svg'
                        } else {
                            return './red_flag_icons/red.svg'
                        }
                });

                div.transition()
                    .duration(50)
                    .style("opacity", 1);
                div.html(i.department_name)
                    .style("left", (data.pageX + 10) + "px")
                    .style("top", (data.pageY - 15) + "px");
            })
            .on('mouseout', function (data, i) {
                    if (i.selected != '1') {
                        d3.select(this).attr("xlink:href", function (i) {
                            if (i.cari_quantiles == 0) {
                                return './red_flag_icons/blue_outline.svg'
                            } else if (i.cari_quantiles == 1) {
                                return './red_flag_icons/light_blue_outline.svg'
                            } else if (i.cari_quantiles == 2) {
                                return './red_flag_icons/light_red_outline.svg'
                            } else {
                                return './red_flag_icons/red_outline.svg'
                            }
                        });
                    }

                    //Makes the new div disappear:
                    div.transition()
                        .duration('100')
                        .style("opacity", 0);
                }
            )
            .on('click', function(d,i) {
                update_bubble_chart(i.department)

                var dept_names = ['amazonas', 'antioquia', 'arauca', 'archipielago_de_san_andres',
                    'atlantico', 'bogota_dc', 'bolivar', 'boyaca', 'caldas', 'caqueta',
                    'casanare', 'cauca', 'cesar', 'choco', 'cordoba', 'cundinamarca',
                    'huila', 'la_guajira', 'magdalena', 'meta', 'narino',
                    'norte_de_santander', 'putumayo', 'quindio', 'risaralda',
                    'santander', 'sucre', 'tolima', 'valle_del_cauca', 'vaupes',
                    'vichada'];
                for (var index = 0; index < dept_names.length; index++) {
                    var cur_name = dept_names[index];
                    var flag_svg = document.getElementById(cur_name);

                    if (flag_svg.__data__.cari_quantiles == 0) {
                        flag_svg.setAttribute("href", './red_flag_icons/blue_outline.svg');
                    } else if (flag_svg.__data__.cari_quantiles == 1) {
                        flag_svg.setAttribute("href", './red_flag_icons/light_blue_outline.svg');
                    } else if (flag_svg.__data__.cari_quantiles == 2) {
                        flag_svg.setAttribute("href", './red_flag_icons/light_red_outline.svg');
                    } else {
                        flag_svg.setAttribute("href", './red_flag_icons/red_outline.svg');
                    }
                    flag_svg.__data__.selected = "0";
                }

                var dept_flag_svg = document.getElementById(i.department);

                if (dept_flag_svg.__data__.cari_quantiles == 0) {
                    dept_flag_svg.setAttribute("href", './red_flag_icons/blue.svg');
                } else if (dept_flag_svg.__data__.cari_quantiles == 1) {
                    dept_flag_svg.setAttribute("href", './red_flag_icons/light_blue.svg');
                } else if (dept_flag_svg.__data__.cari_quantiles == 2) {
                    dept_flag_svg.setAttribute("href", './red_flag_icons/light_red.svg');
                } else {
                    dept_flag_svg.setAttribute("href", './red_flag_icons/red.svg');
                }
                dept_flag_svg.__data__.selected = "1";
                document.getElementById("department_label").innerText=i.department_name;
            });

        position_station_markers(markers);
    }

    var div = d3.select("body").append("div")
        .attr("class", "tooltip-donut")
        .style("opacity", 0);

    function position_station_markers(markers) {
        markers
            .attr("transform", function(d) {return "translate(" + (project(d).x)+","+ (project(d).y-25) + ")";});
    }
    function project(d) {
        return map.project(new mapboxgl.LngLat(+d.lng, +d.lat));
    }


    let redFlagsFile = "./data_files/dept_coords.json";
    let red_markers;

    let station_data;

    map.on("load", () => {
        fetch(redFlagsFile)
            .then((response) => response.json())
            .then((d) => (station_data = d))
            .then((d) => create_flag_markers(d, './red_flag_icon.svg', red_markers))
            // .then(function (d){
            //         update_bubble_chart("bolivar")
            //         var dept_flag_svg = document.getElementById("bolivar");
            //         dept_flag_svg.setAttribute("href", "./deep_red_flag_icon.svg");
            //   });

    });


    const marker_container = d3
        .select(map.getCanvasContainer() )
        .append("svg")
        .attr("width", "100%")
        .attr("height", "100%")
        .style("position", "absolute")
        .style("z-index", 2);


    ////////////////////////////////////// bubble stuff
    import {BubbleChart} from "./bubbles.js";
    // load the data

    function update_bubble_chart(dpt_name) {
        var plot_data = [];

        d3.csv("data_files/by_department/"+ dpt_name + "_clean_dataset.csv").then((data) => {
            var insecure_counter = 0;
            var pop_counter = 0;
            for (var i = 0; i < data.length; i++) {
                var is_insecure = parseFloat(data[i].cari) > 2.0;
                insecure_counter += is_insecure * parseFloat(data[i].household_size)
                pop_counter += parseFloat(data[i].household_size)
                plot_data.push({"size": data[i].household_size, "aid": data[i].government_assistance, "group": Math.round(data[i].cari)})
            }
            console.log(plot_data)

            document.getElementById("my_dataviz").innerHTML = "";
            // var svg = d3.select("svg");
            // svg.selectAll("*").remove();

            let box = document.querySelector('.bubble-box');
            let width = box.clientWidth;
            let height = box.clientHeight;
            let BC = new BubbleChart("#my_dataviz", width, height, dpt_name)
            BC.initialize_nodes(plot_data)
        });

    }

    // document.getElementById('color_select').addEventListener('change', function() {
    //     update_bubble_chart(document.getElementById('dpt_select').value)
    // });

</script>