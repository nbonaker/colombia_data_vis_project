<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>ðŸš©s of Colombia</title>
  <!-- Load d3.js -->
  <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
  <script src="https://d3js.org/d3.v6.js" charset="utf-8"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.js"></script>
  <link rel="stylesheet" href="main_stylesheet.css">
</head>
<style>
  .map-box{
    background-color:white;
    background-clip: content-box;
    border-radius: 20px;
    width: 66%;
    height: 100%;
    display: table-cell;

  }
  #map {
    border-radius: 20px;
    background-clip: content-box;
    width: 100%;
    height: 100%;
  }
  .description-box{
    background-color:white;
    background-clip: content-box;
    border-radius: 20px;
    width: 33%;
    height: 100%;
    display: table-cell;
    padding-left: 5px;
    vertical-align: top;
  }
  .description-box-text{
    display: block;
    width: 90%;
    height: 95%;
    padding-left: 5%;
    padding-top: 5%;
  }
  .tooltip-donut {
    position: absolute;
    text-align: center;
    padding: .5rem;
    background: #FFFFFF;
    color: #313639;
    border: 1px solid #313639;
    border-radius: 8px;
    pointer-events: none;
    font-size: 1.0rem;
    z-index: 2;
  }
</style>
<body>

  <div class="title-box">
    <div class="title-box-text">Some People are Slipping Through the Cracks</div>
  </div>

  <div class="content-container">
    <div style="display: table-row; padding: 10px;">
      <div class="map-box">
        <div id="map" ></div>
      </div>
      <div class="description-box">
        <div class="description-box-text">

          <h2>Overview: The Situation in Colombia</h2>
          <p>40% of the population are food insecure</p>
          <p>60% of population is receiving aid of some form</p>
          <p>Almost all aid comes from the Colombian Government</p>
          <h3>Both the level of food insecurity and the distribution of aid varies significantly by locality. </h3>

          <h2>Where are People Falling Through the Cracks?</h2>
          <p><img src = "red_flag_icon.svg" width="20" height="20"/> Lighter red flags denote cites where food insecurity
          is higher than the national average.</p>
          <p><img src = "deep_red_flag_icon.svg" width="20" height="20"/> Darker red flags denote cites where BOTH food insecurity
            is higher than the national average AND governemnt aid is below the national average.</p>
        </div>
      </div>
    </div>
  </div>
  <div id="includeHtml" class="timeline-box"></div>

<script>
  $(function() {
    $("#includeHtml").load("timeline.html");
  });
  // load mabbox map
  mapboxgl.accessToken = "pk.eyJ1IjoibmJvbmFrZXIiLCJhIjoiY2p0bmRkNmdtMDloZzQ0cXBpM2trb2owYyJ9.WthQbtkv3vaXA8rrVoo-hg";
  const map = new mapboxgl.Map({
    container: "map",
    style: "mapbox://styles/nbonaker/clgvf3qjv00d701pi6xyafcbq",
    center: [-73.2973, 3.9],
    zoom: 4.8, // starting zoom level
    dragPan: false,
    interactive: false
  });
  // disable map zoom when using scroll
  map.scrollZoom.disable();

  function create_flag_markers(station_data, icon_file, markers) {
    console.log(station_data)
    markers = marker_container
            .selectAll("circle")
            .data(station_data)
            .enter()
            .append("svg:image")
            .attr('width', 25)
            .attr('height', 25)
            .attr("fill-opacity", 0.4)
            .attr("xlink:href",
                    icon_file)
            .attr("name", function (d) {
              return d.city;
            })
            .on('mouseover', function (data, i) {
              d3.select(this).transition()
                      .duration('50')
                      .attr('opacity', '.85');
              div.transition()
                      .duration(50)
                      .style("opacity", 1);
              div.html(i.city)
                      .style("left", (data.pageX + 10) + "px")
                      .style("top", (data.pageY - 15) + "px");
            })
            .on('mouseout', function (data, i) {
                      d3.select(this).transition()
                              .duration('100')
                              .attr('opacity', '1');
                      //Makes the new div disappear:
                      div.transition()
                              .duration('100')
                              .style("opacity", 0);
                    }
            );


    position_station_markers(markers);
  }

  var div = d3.select("body").append("div")
          .attr("class", "tooltip-donut")
          .style("opacity", 0);

  function position_station_markers(markers) {
    markers
            .attr("transform", function(d) {return "translate(" + (project(d).x)+","+ (project(d).y-25) + ")";});
  }
  function project(d) {
    return map.project(new mapboxgl.LngLat(+d.lng, +d.lat));
  }


  let redFlagsFile = "./data_files/red_flags_city_coords.json";
  let red_markers;

  let yellowFlagsFile = "./data_files/yellow_flags_city_coords.json";
  let yellow_markers;

  map.on("load", () => {
    fetch(yellowFlagsFile)
            .then((response) => response.json())
            .then((d) => (station_data = d))
            .then((d) => create_flag_markers(d, './red_flag_icon.svg', red_markers));

    fetch(redFlagsFile)
            .then((response) => response.json())
            .then((d) => (station_data = d))
            .then((d) => create_flag_markers(d, './deep_red_flag_icon.svg', yellow_markers));
  });


  const marker_container = d3
          .select(map.getCanvasContainer() )
          .append("svg")
          .attr("width", "100%")
          .attr("height", "100%")
          .style("position", "absolute")
          .style("z-index", 2);

  // resizes the map when resizing event finishes (prevents jittering)
  // window.onresize = function() {
  //   position_station_markers(red_markers)
  //   // position_station_markers()
  // }
</script>
</body>
</html>