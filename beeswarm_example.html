<!-- Source code and data for the swarm plot tutorial at https://www.chartfleau.com/tutorials/d3swarm
This code introduces the concept of a D3 force simulation to lay out elements on a chart.
A video lesson walking through a more advanced project, including fluid animation of time series data,
is now available from Gumroad: https://chartfleau.gumroad.com/l/masterclass -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <title>D3 Swarm Plot</title>
</head>
<style>
    .axis-grid line {
        stroke: #d5d5d5;
    }
</style>
<body></body>
</html>
<script>
    const width = 1000;
    const height = 500;
    const margin = [50, 50, 50, 180];

    let svg = d3
        .select("body")
        .append("svg")
        .attr("height", height)
        .attr("width", width);

    d3.csv("data_files/food_cost_data.csv").then((data) => {
        console.log(data)
        // let sectors = Array.from(new Set(data.map((d) => d.cari_category)));
        // console.log(sectors)
        let sectors = ["Severe Insecurity", "Moderate Insecurity",  "Marginal Security", "Secure"]

        let xScale = d3
            .scaleBand()
            .domain(sectors)
            .range([margin[3], width - margin[1]]);

        var x_axis = d3.axisBottom()
            .scale(xScale);

        let yScale = d3
            .scaleLinear()
            .domain(d3.extent(data.map((d) => +d["cost_food_total"])))
            .domain([0, 1600000])
                .range([height - margin[2], margin[0]]);

        var y_axis = d3.axisLeft()
            .scale(yScale);

        const yAxisGrid = d3.axisLeft(yScale).tickSize(-width+margin[3]+margin[1]).tickFormat('').ticks(10);

        svg.append('g')
            .attr('class', 'y axis-grid')
            .attr("transform", "translate(75, 10)")
            .call(yAxisGrid);

        let color = d3.scaleOrdinal().domain(sectors).range(["#910b00", "#ff1200", "#24c6f3", "#0443a6"]);

        let marketcapDomain = d3.extent(data.map((d) => +d["household_size"]));
        let size = d3.scaleSqrt().domain(marketcapDomain).range([3, 15]);

        svg
            .selectAll(".circ")
            .data(data)
            .enter()
            .append("circle")
            .attr("class", "circ")
            .attr("stroke", "black")
            .attr("fill", (d) => color(d.cari_category))
            .attr("r", (d) => size(d["household_size"]))
            .attr("cx", (d) => xScale(d.cari_category))
            .attr("cy", (d) => yScale(d.cost_food_total));

        let simulation = d3
            .forceSimulation(data)
            .force(
                "x",
                d3
                    .forceX((d) => {
                        return xScale(d.cari_category)-5;
                    })
                    .strength(0.2)
            )
            .force(
                "y",
                d3
                    .forceY(function (d) {
                        return yScale(d.cost_food_total);
                    })
                    .strength(1)
            )
            .force(
                "collide",
                d3.forceCollide((d) => {
                    return size(d["household_size"]);
                })
            )
            .alphaDecay(0)
            .alpha(0.3)
            .on("tick", tick);

        function tick() {
            d3.selectAll(".circ")
                .attr("cx", (d) => d.x)
                .attr("cy", (d) => d.y);
        }

        let init_decay = setTimeout(function () {
            console.log("start alpha decay");
            simulation.alphaDecay(0.03);
        }, 500);

        var xAxisTranslate = height - margin[0]+10;

        svg.append("g")
            .attr("transform", "translate(-105, " + xAxisTranslate  +")")
            .call(x_axis)
        svg.append("g").attr("transform", "translate(75, 10)").call(y_axis)



    });
</script>